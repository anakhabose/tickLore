{{>header}}

<!-- Add Address Modal -->
<div id="addressModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
  <div class="bg-white p-6 rounded w-full max-w-4xl mx-4 sm:mx-0">
    <h2 id="modalTitle" class="text-xl font-semibold mb-4">Add New Address</h2>
    <form id="addressForm" class="space-y-6">
      <input type="hidden" id="addressId" />
      
      <!-- Name Field -->
      <div>
        <label class="block font-medium">Name</label>
        <input type="text" id="name" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-yellow-500" required minlength="2" maxlength="50" />
      </div>

      <!-- Address Fields in Same Row -->
      <div class="flex space-x-4">
        <div class="flex-1">
          <label class="block font-medium">Address Line 1</label>
          <input type="text" id="addressLine1" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-yellow-500" required minlength="5" maxlength="100" />
        </div>
        <div class="flex-1">
          <label class="block font-medium">Address Line 2 (Optional)</label>
          <input type="text" id="addressLine2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-yellow-500" maxlength="100" />
        </div>
      </div>

      <!-- City and State Fields in Same Row -->
      <div class="flex space-x-4">
        <div class="flex-1">
          <label class="block font-medium">City</label>
          <input type="text" id="city" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-yellow-500" required minlength="2" maxlength="50" />
        </div>
        <div class="flex-1">
          <label class="block font-medium">State</label>
          <input type="text" id="state" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-yellow-500" required minlength="2" maxlength="50" />
        </div>
      </div>

      <!-- Country and Pincode Fields in Same Row -->
      <div class="flex space-x-4">
        <div class="flex-1">
          <label class="block font-medium">Country</label>
          <input type="text" id="country" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-yellow-500" required minlength="2" maxlength="50" />
        </div>
        <div class="flex-1">
          <label class="block font-medium">Pincode</label>
          <input type="text" id="pincode" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-yellow-500" required pattern="^[1-9][0-9]{5}$" />
        </div>
      </div>

      <!-- Phone Number Field -->
      <div>
        <label class="block font-medium">Phone Number</label>
        <input type="text" id="phoneNumber" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-yellow-500" required pattern="^[6-9][0-9]{9}$" />
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-end space-x-2">
        <button type="button" id="cancelBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
        <button type="button" id="saveAddressBtn" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">Save Address</button>
      </div>
    </form>
  </div>
</div>

<div class="flex flex-col md:flex-row min-h-screen bg-gray-50">
 
 <div class="container mx-auto p-6 md:p-12">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Billing Details -->
            <div>
                <h2 class="text-2xl font-semibold mb-6">Select Delivery Address</h2>
                
                <!-- Add New Address Button -->
                <button id="addAddressBtn" class="mb-6 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg flex items-center">
                    <i class="fas fa-plus mr-2"></i>
                    Add New Address
                </button>

                <!-- Address List -->
                <div class="space-y-4">
                    {{#if addresses.length}}
                        {{#each addresses}}
                        <div class="border p-4 rounded-lg hover:border-yellow-500 relative">
                            <div class="flex items-start">
                                <input type="radio" name="selectedAddress" value="{{this._id}}" 
                                       class="mt-1 mr-4" required
                                       data-address='{{json this}}'>
                                <div class="flex-1">
                                    <p class="font-semibold">{{this.name}}</p>
                                    <p>{{this.addressLine1}}</p>
                                    {{#if this.addressLine2}}
                                        <p>{{this.addressLine2}}</p>
                                    {{/if}}
                                    <p>{{this.city}}, {{this.state}}</p>
                                    <p>{{this.country}} - {{this.pincode}}</p>
                                    <p>Phone: {{this.phoneNumber}}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="openEditModal({{json this}})" 
                                            class="text-blue-500 hover:text-blue-700">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteAddress('{{this._id}}')"
                                            class="text-red-500 hover:text-red-700">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {{/each}}
                    {{else}}
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-gray-500">No addresses found. Please add a new address.</p>
                        </div>
                    {{/if}}
                </div>
            </div>

            <!-- Order Summary -->
            <div>
                <div class="bg-white shadow-lg rounded-lg p-6">
                    <h2 class="text-lg font-semibold mb-4">Cart Total</h2>
                    <div class="space-y-4">
                        <!-- Product List -->
                        <div class="space-y-4">
                            {{#each cartItems}}
                            <div class="flex justify-between items-center">
                                <div class="flex items-center space-x-3">
                                    <img src="{{this.productId.images.[0]}}" alt="{{this.productId.productName}}" class="rounded-md w-12 h-12 object-cover" />
                                    <span>{{this.productId.productName}} x {{this.quantity}}</span>
                                </div>
                                <div class="flex flex-col items-end">
                                    {{#if this.hasOffer}}
                                        <span class="text-sm line-through text-gray-500">Rs.{{this.originalPrice}}</span>
                                        <span>Rs.{{this.salePrice}}</span>
                                    {{else}}
                                        <span>Rs.{{this.originalPrice}}</span>
                                    {{/if}}
                                </div>
                            </div>
                            {{/each}}
                        </div>

                        <!-- Summary Calculations -->
                        <div class="border-t pt-4">
                            <div class="flex justify-between border-b pb-4">
                                <span>Subtotal:</span>
                                <span>Rs. {{subtotal}}</span>
                            </div>
                            <div class="flex justify-between border-b pb-4">
                                <span>Shipping:</span>
                                <span>Rs. {{deliveryCharges}}</span>
                            </div>
                            <!-- Discount Row (initially hidden) -->
                            <div id="discountRow" class="flex justify-between border-b pb-4 hidden">
                                <span>Discount:</span>
                                <span id="discountAmount" class="text-green-600">-Rs. 0</span>
                            </div>
                            <div class="flex justify-between font-semibold pt-4">
                                <span>Total:</span>
                                <span id="finalTotal">Rs. {{totalAmount}}</span>
                            </div>
                        </div>

                        <!-- Coupon Section -->
                        <div class="mt-6">
                            <h3 class="font-semibold mb-2">Available Coupons</h3>
                            {{#if hasCoupons}}
                                
                                    <div class="flex space-x-2">
                                        <select id="couponSelect" class="flex-1 border rounded-lg px-4 py-2">
                                            <option value="">Select a Coupon</option>
                                            {{#each availableCoupons}}
                                                <option value="{{this._id}}" 
                                                        data-discount="{{this.discount}}" 
                                                        data-min="{{this.minPurchaseAmount}}">
                                                    {{this.couponCode}} - Save Rs.{{this.discount}} 
                                                    (Min. Purchase: Rs.{{this.minPurchaseAmount}})
                                                </option>
                                            {{/each}}
                                        </select>
                                        <button type="button" 
                                                id="applyCouponBtn" 
                                                class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                                            Apply
                                        </button>
                                    </div>
                               
                            {{else}}
                                <div class="bg-gray-100 rounded-lg p-4 text-center text-gray-600">
                                    <i class="fas fa-ticket-alt mr-2"></i>
                                    No coupons available for this purchase
                                </div>
                            {{/if}}
                        </div>

                        <!-- Payment Method Selection -->
                        <div class="mt-6 border-t pt-4">
                            <h3 class="font-semibold mb-4">Payment Method</h3>
                            {{#if isCodAvailable}}
                                <div class="space-y-3">
                                    <label class="flex items-center space-x-3">
                                        <input type="radio" name="paymentMethod" value="cod" class="form-radio text-yellow-500">
                                        <span>Cash on Delivery</span>
                                    </label>
                                    <label class="flex items-center space-x-3">
                                        <input type="radio" name="paymentMethod" value="razorpay" class="form-radio text-yellow-500">
                                        <span>Razorpay</span>
                                    </label>
                                </div>
                            {{else}}
                                <div class="mb-4">
                                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                                        <p class="font-bold">Note:</p>
                                        <p>Cash on Delivery is not available for orders above â‚¹1000. Please proceed with online payment.</p>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    <label class="flex items-center space-x-3">
                                        <input type="radio" name="paymentMethod" value="razorpay" class="form-radio text-yellow-500" checked>
                                        <span>Razorpay</span>
                                    </label>
                                </div>
                            {{/if}}
                        </div>

                        <!-- Place Order Button -->
                        <div class="mt-6">
                            <button type="submit" 
                                    onclick="submitOrder(event)"
                                    class="w-full px-6 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-semibold">
                                Place Order
                            </button>
                        </div>
                    </div>
                </div>
               
            </div>
        </div>
    </div>
</div>
    {{>userFooter}}

 

<script>
// Global variables
let originalTotal;
let currentDiscount = 0;
let isCouponApplied = false;

// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize originalTotal
    const finalTotalElement = document.getElementById('finalTotal');
    if (finalTotalElement) {
        originalTotal = parseFloat(finalTotalElement.textContent.replace('Rs. ', ''));
    }

    // Add event listeners
     const couponButton = document.querySelector('#applyCouponBtn');
    if (couponButton) {
        couponButton.addEventListener('click', toggleCoupon);
    }

    const submitOrderBtn = document.querySelector('button[type="submit"][class*="bg-yellow-500"]');
    if (submitOrderBtn) {
        submitOrderBtn.addEventListener('click', submitOrder);
    }

    const saveAddressBtn = document.querySelector('button[onclick="saveAddress(event)"]');
    if (saveAddressBtn) {
        saveAddressBtn.removeAttribute('onclick');
        saveAddressBtn.addEventListener('click', saveAddress);
    }

    // Initialize form validation
    const form = document.getElementById('billing-form');
    if (form) {
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            field.addEventListener('invalid', (e) => {
                e.preventDefault();
                Swal.fire({
                    title: 'Validation Error',
                    text: 'Please fill in all required fields.',
                    icon: 'warning',
                    confirmButtonText: 'OK'
                });
            });
        });
    }

    // Add modal event listeners
    const openModalBtn = document.querySelector('button[onclick="openAddressModal()"]');
    if (openModalBtn) {
        openModalBtn.removeAttribute('onclick');
        openModalBtn.addEventListener('click', openAddressModal);
    }

    const closeModalBtn = document.querySelector('button[onclick="closeAddressModal()"]');
    if (closeModalBtn) {
        closeModalBtn.removeAttribute('onclick');
        closeModalBtn.addEventListener('click', closeAddressModal);
    }
});

// Modal Functions
function openAddressModal() {
     const modal = document.getElementById('addressModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
    }
}

function closeAddressModal() {
     const modal = document.getElementById('addressModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.add('hidden');
    }
}

function selectAddress(address) {
     // Parse the address if it's a string
    const addressData = typeof address === 'string' ? JSON.parse(address) : address;
    
    const form = document.getElementById('billing-form');
    if (!form) {
        console.error('Billing form not found');
        return;
    }

    // Store the complete address object
    form.dataset.addressId = addressData._id;
    form.dataset.selectedAddress = JSON.stringify(addressData);
    
    // Fill form fields
    document.getElementById('companyName').value = addressData.name || '';
    document.getElementById('streetAddress').value = addressData.addressLine1 || '';
    document.getElementById('apartment').value = addressData.addressLine2 || '';
    document.getElementById('townCity').value = addressData.city || '';
    document.getElementById('state').value = addressData.state || '';
    document.getElementById('country').value = addressData.country || '';
    document.getElementById('pincode').value = addressData.pincode || '';
    document.getElementById('phone').value = addressData.phoneNumber || '';

    closeAddressModal();
    
    Swal.fire({
        icon: 'success',
        title: 'Address Selected',
        text: 'Delivery address has been selected successfully',
        timer: 1500,
        showConfirmButton: false
    });
}

function toggleCoupon() {
    if (!isCouponApplied) {
        applyCoupon();
    } else {
        removeCoupon();
    }
}
// Coupon Function
function applyCoupon() {
    const couponSelect = document.getElementById('couponSelect');
    if (!couponSelect) return;

    const selectedOption = couponSelect.options[couponSelect.selectedIndex];
    const form = document.getElementById('billing-form');
    
    if (!selectedOption.value) {
        Swal.fire({
            icon: 'warning',
            title: 'No Coupon Selected',
            text: 'Please select a coupon to apply'
        });
        return;
    }

    const discountAmount = parseFloat(selectedOption.dataset.discount);
    const minimumPurchase = parseFloat(selectedOption.dataset.min);

    if (originalTotal < minimumPurchase) {
        Swal.fire({
            icon: 'error',
            title: 'Cannot Apply Coupon',
            text: `Minimum purchase amount of Rs.${minimumPurchase} required`,
        });
        return;
    }

    // Calculate final amount with discount
    const finalAmount = originalTotal - discountAmount;

    // Update UI
    const discountRow = document.getElementById('discountRow');
    const discountAmountElement = document.getElementById('discountAmount');
    const finalTotalElement = document.getElementById('finalTotal');
    const couponButton = document.querySelector('#applyCouponBtn');

    if (discountRow) discountRow.classList.remove('hidden');
    if (discountAmountElement) discountAmountElement.textContent = `-Rs.${discountAmount.toFixed(2)}`;
    if (finalTotalElement) finalTotalElement.textContent = `Rs.${finalAmount.toFixed(2)}`;
    if (couponButton) {
        couponButton.textContent = 'Remove';
        couponButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
        couponButton.classList.add('bg-red-500', 'hover:bg-red-600');
    }
    
    currentDiscount = discountAmount;
    isCouponApplied = true;

    // Store coupon info for order submission
    if (form) {
        form.dataset.couponId = selectedOption.value;
        form.dataset.discountAmount = discountAmount;
    }

    // Disable the coupon select while coupon is applied
    couponSelect.disabled = true;

    Swal.fire({
        icon: 'success',
        title: 'Coupon Applied!',
        text: `Discount of Rs.${discountAmount} has been applied to your order`,
    });
}

function removeCoupon() {
    const discountRow = document.getElementById('discountRow');
    const finalTotalElement = document.getElementById('finalTotal');
    const couponButton = document.querySelector('#applyCouponBtn');
    const couponSelect = document.getElementById('couponSelect');
    const form = document.getElementById('billing-form');

    // Reset UI
    if (discountRow) discountRow.classList.add('hidden');
    if (finalTotalElement) finalTotalElement.textContent = `Rs.${originalTotal.toFixed(2)}`;
    if (couponButton) {
        couponButton.textContent = 'Apply';
        couponButton.classList.remove('bg-red-500', 'hover:bg-red-600');
        couponButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
    }

    // Reset coupon select to default option
    if (couponSelect) {
        couponSelect.value = '';  // Reset to default option
        couponSelect.disabled = false;
    }

    // Reset variables
    currentDiscount = 0;
    isCouponApplied = false;

    // Remove coupon info from form
    if (form) {
        delete form.dataset.couponId;
        delete form.dataset.discountAmount;
    }

    Swal.fire({
        icon: 'success',
        title: 'Coupon Removed',
        text: 'The coupon has been removed from your order',
    });
}


async function saveAddress(event) {
    event.preventDefault();
    const form = document.getElementById('billing-form');

    // Add validation checks
    const requiredFields = {
        name: document.getElementById('companyName').value,
        addressLine1: document.getElementById('streetAddress').value,
        city: document.getElementById('townCity').value,
        state: document.getElementById('state').value,
        country: document.getElementById('country').value,
        pincode: document.getElementById('pincode').value,
        phoneNumber: document.getElementById('phone').value
    };

    // Check for empty required fields
    const emptyFields = Object.entries(requiredFields)
        .filter(([_, value]) => !value.trim())
        .map(([key]) => key);

    if (emptyFields.length > 0) {
        Swal.fire({
            title: 'Missing Information',
            text: `Please fill in the following fields: ${emptyFields.join(', ')}`,
            icon: 'warning',
            confirmButtonText: 'OK'
        });
        return;
    }

    // Validate phone number format
    const phoneRegex = /^\d{10}$/;  // Assumes 10-digit phone number
    if (!phoneRegex.test(requiredFields.phoneNumber)) {
        Swal.fire({
            title: 'Invalid Phone Number',
            text: 'Please enter a valid 10-digit phone number',
            icon: 'warning',
            confirmButtonText: 'OK'
        });
        return;
    }

    // Validate pincode format
    const pincodeRegex = /^\d{6}$/;  // Assumes 6-digit pincode
    if (!pincodeRegex.test(requiredFields.pincode)) {
        Swal.fire({
            title: 'Invalid Pincode',
            text: 'Please enter a valid 6-digit pincode',
            icon: 'warning',
            confirmButtonText: 'OK'
        });
        return;
    }

    const addressData = {
        ...requiredFields,
        addressLine2: document.getElementById('apartment').value || ''  // Optional field
    };

    try {
        const response = await fetch('/user/addAddress', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(addressData)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to save address');
        }

        const result = await response.json();

        Swal.fire({
            title: 'Success!',
            text: 'Address saved successfully',
            icon: 'success',
            confirmButtonText: 'OK'
        }).then(() => {
            // Optionally refresh the address list or update UI
            location.reload();  // Or implement a more elegant UI update
        });

    } catch (error) {
        console.error('Save address error:', error);
        Swal.fire({
            title: 'Error',
            text: error.message || 'Failed to save address',
            icon: 'error',
            confirmButtonText: 'OK'
        });
    }
}

// Add this function before submitOrder
async function validateOrderBeforeSubmit() {
    try {
        const response = await fetch('/user/validate-order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();
        if (!data.success) {
            await Swal.fire({
                icon: 'error',
                title: 'Order Validation Failed',
                text: data.message,
                confirmButtonText: 'OK'
            });
            return false;
        }
        return true;
    } catch (error) {
        console.error('Validation error:', error);
        await Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to validate order. Please try again.',
            confirmButtonText: 'OK'
        });
        return false;
    }
}

// Modify the submitOrder function
async function submitOrder(event) {
    event.preventDefault();

    // First check for address selection
    const selectedAddressRadio = document.querySelector('input[name="selectedAddress"]:checked');
    if (!selectedAddressRadio) {
        Swal.fire({
            icon: 'warning',
            title: 'Address Required',
            text: 'Please select a delivery address',
            confirmButtonColor: '#3085d6'
        });
        return;
    }

    // Then check for payment method
    const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
    if (!selectedPaymentMethod) {
        Swal.fire({
            icon: 'warning',
            title: 'Payment Method Required',
            text: 'Please select a payment method',
            confirmButtonColor: '#3085d6'
        });
        return;
    }

    // Only proceed with stock validation if address and payment method are selected
    const isValid = await validateOrderBeforeSubmit();
    if (!isValid) {
        return;
    }

    const selectedAddress = JSON.parse(selectedAddressRadio.dataset.address);
    const addressId = selectedAddressRadio.value;
    const paymentMethod = selectedPaymentMethod.value;

    // Get coupon information if applied
    let couponId = null;
    if (isCouponApplied) {
        const couponSelect = document.getElementById('couponSelect');
        if (couponSelect && couponSelect.value) {
            couponId = couponSelect.value;
        }
    }

    if (paymentMethod === 'razorpay') {
        // Create payment data object
        const paymentData = {
            address: selectedAddress,
            couponId: couponId,
            discountAmount: currentDiscount || 0,
            finalAmount: originalTotal - (currentDiscount || 0)
        };
        initiateRazorpayPayment(originalTotal, paymentData);
        return;
    }

    // For COD or other payment methods
    const orderData = {
        addressId: addressId,
        paymentMethod: paymentMethod,
        couponId: couponId,  // Updated to use the local couponId variable
        discountAmount: currentDiscount || 0,
        finalAmount: originalTotal - (currentDiscount || 0)
    };

    try {
        const response = await fetch('/user/checkout', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderData),
        });

        const result = await response.json();

        if (response.ok) {
            await Swal.fire({
                title: 'Order Placed!',
                text: 'Thank you for shopping with us.',
                icon: 'success',
                confirmButtonText: 'View Orders',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: true
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/user/orders';
                }
            });
        } else {
            await Swal.fire({
                title: 'Order Error',
                text: result.message || 'Unable to process your order',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }
    } catch (error) {
        console.error('Checkout error:', error);
        await Swal.fire({
            title: 'Network Error',
            text: 'Unable to connect to the server. Please check your internet connection.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
    }
}

// Razorpay Integration
// Make sure Razorpay is loaded before executing payment code
function initializePayment() {
    // Check if Razorpay is loaded
    if (typeof Razorpay === 'undefined') {
        console.error('Razorpay not loaded');
        Swal.fire({
            icon: 'error',
            title: 'Payment Error',
            text: 'Payment system is not properly loaded. Please refresh the page and try again.'
        });
        return false;
    }
    return true;
}

function initiateRazorpayPayment(amount, paymentData) {
    // Validate Razorpay initialization
    if (!initializePayment()) return;

    const finalAmount = originalTotal - (currentDiscount || 0);
    
    // Validate required data
    if (!paymentData || !paymentData.address) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Invalid payment data. Please try again.'
        });
        return;
    }

    fetch('/user/create-razorpay-order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            amount: originalTotal,
            discountedAmount: finalAmount
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to create payment order');
        }
        return response.json();
    })
    .then(data => {
        if (!data.success) {
            throw new Error(data.message || 'Failed to create payment order');
        }

        const options = {
            key: data.key,
            amount: data.order.amount,
            currency: "INR",
            name: "tickLore",
            description: "Order Payment",
            order_id: data.order.id,
            handler: function (response) {
                verifyPayment(response, paymentData);
            },
            modal: {
                ondismiss: async function() {
                    try {
                        const response = await fetch('/user/create-pending-order', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                address: paymentData.address,
                                couponId: paymentData.couponId || null,
                                discountAmount: paymentData.discountAmount || 0,
                                finalAmount: paymentData.finalAmount || originalTotal
                            })
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            await Swal.fire({
                                title: 'Payment Pending',
                                text: 'Your order has been created. You can complete the payment from your orders page.',
                                icon: 'info',
                                confirmButtonText: 'Go to Orders'
                            });
                            window.location.href = '/user/orders';
                        } else {
                            throw new Error(result.message || 'Failed to create pending order');
                        }
                    } catch (error) {
                        console.error('Error creating pending order:', error);
                        await Swal.fire({
                            title: 'Error',
                            text: error.message || 'Failed to create order. Please try again.',
                            icon: 'error'
                        });
                    }
                }
            },
            prefill: {
                name: document.getElementById('name')?.value || '',
                email: '', // Add email field if needed
            },
            theme: {
                color: "#3399cc"
            }
        };

        const rzp = new Razorpay(options);
        rzp.open();
    })
    .catch(error => {
        console.error('Payment initialization error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Payment Error',
            text: error.message || 'Failed to initialize payment. Please try again.'
        });
    });
}

// ... existing code ...
function verifyPayment(response, paymentData) {
    if (!paymentData) {
        console.error('Payment data is missing');
        return;
    }

    const formData = {
        razorpay_payment_id: response.razorpay_payment_id,
        razorpay_order_id: response.razorpay_order_id,
        razorpay_signature: response.razorpay_signature,
        addressId: paymentData.address._id,
        address: paymentData.address,
        couponId: paymentData.couponId,
        discountAmount: paymentData.discountAmount,
        finalAmount: paymentData.finalAmount,
        paymentMethod: 'razorpay',
        paymentStatus: 'completed'
    };

    console.log('Verifying payment with data:', formData);

    // First verify the payment
    fetch('/user/verify-razorpay-payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            throw new Error(orderData.message || 'Failed to create order');
        }

        // Only show success message and redirect if both payment verification and order creation succeed
        return Swal.fire({
            icon: 'success',
            title: 'Order Placed Successfully!',
            text: 'Your payment was successful and order has been placed',
            allowOutsideClick: false,
            allowEscapeKey: false,
            allowEnterKey: false,
            showConfirmButton: true,
            confirmButtonText: 'View Orders'
        });
    })
    .then((result) => {
        if (result.isConfirmed) {
            window.location.href = '/user/orders';
        }
    })
    .catch(error => {
        console.error('Payment/Order creation error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message || 'Failed to process payment and create order',
            confirmButtonText: 'OK'
        }).then(() => {
            // Optionally redirect to cart or another appropriate page
            window.location.href = '/user/cart';
        });
    });
}

// Add the handlePaymentError function
function handlePaymentError(errorMessage) {
    Swal.fire({
        icon: 'error',
        title: 'Payment Failed',
        text: errorMessage || 'Something went wrong with the payment. Please try again.',
        confirmButtonText: 'OK'
    });
}

document.addEventListener('DOMContentLoaded', () => {
  // Get DOM elements
  const addressModal = document.getElementById('addressModal');
  const addAddressBtn = document.getElementById('addAddressBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const addressForm = document.getElementById('addressForm');

  // Remove any existing onsubmit attribute from the form
  addressForm.removeAttribute('onsubmit');

  // Toggle modal visibility
  const toggleModal = (show) => {
    addressModal.classList.toggle('hidden', !show);
  };

  // Event listeners
  addAddressBtn.addEventListener('click', () => {
    addressForm.reset();
    document.getElementById('modalTitle').textContent = 'Add New Address';
    document.getElementById('addressId').value = ''; // Clear any existing ID
    toggleModal(true);
  });

  cancelBtn.addEventListener('click', () => {
    toggleModal(false);
    addressForm.reset();
  });

  // Validation function
  function validateForm() {
    const name = document.getElementById('name').value.trim();
    const addressLine1 = document.getElementById('addressLine1').value.trim();
    const city = document.getElementById('city').value.trim();
    const state = document.getElementById('state').value.trim();
    const country = document.getElementById('country').value.trim();
    const pincode = document.getElementById('pincode').value.trim();
    const phoneNumber = document.getElementById('phoneNumber').value.trim();

    // Name validation (2-20 characters)
    if (!name || name.length < 2 || name.length > 20) {
      showError('Name must be between 2 and 20 characters');
      return false;
    }

    // Address validation (5-30 characters)
    if (!addressLine1 || addressLine1.length < 5 || addressLine1.length > 30) {
      showError('Address must be between 5 and 30 characters');
      return false;
    }

    // City validation (2-15 characters)
    if (!city || city.length < 2 || city.length > 15) {
      showError('City must be between 2 and 15 characters');
      return false;
    }

    // State validation (2-15 characters)
    if (!state || state.length < 2 || state.length > 15) {
      showError('State must be between 2 and 15 characters');
      return false;
    }

    // Country validation (2-15 characters)
    if (!country || country.length < 2 || country.length > 15) {
      showError('Country must be between 2 and 15 characters');
      return false;
    }

    // Pincode validation (6 digits, starting with non-zero)
    const pincodeRegex = /^[1-9][0-9]{5}$/;
    if (!pincodeRegex.test(pincode)) {
      showError('Please enter a valid 6-digit pincode');
      return false;
    }

    // Phone number validation (10 digits, starting with 6-9)
    const phoneRegex = /^[1-9][0-9]{9}$/;
    if (!phoneRegex.test(phoneNumber)) {
      showError('Please enter a valid 10-digit phone number');
      return false;
    }

    return true;
  }

  function showError(message) {
    Swal.fire({
      icon: 'error',
      title: 'Validation Error',
      text: message,
      confirmButtonColor: '#EF4444'
    });
  }

  // Handle form submission
  document.getElementById('saveAddressBtn').addEventListener('click', async (event) => {
    event.preventDefault();
    event.stopPropagation();
    
    if (!validateForm()) return;

    const formData = {
        name: document.getElementById('name').value.trim(),
        addressLine1: document.getElementById('addressLine1').value.trim(),
        addressLine2: document.getElementById('addressLine2').value.trim(),
        city: document.getElementById('city').value.trim(),
        state: document.getElementById('state').value.trim(),
        country: document.getElementById('country').value.trim(),
        pincode: document.getElementById('pincode').value.trim(),
        phoneNumber: document.getElementById('phoneNumber').value.trim()
    };

    try {
        const addressId = document.getElementById('addressId').value;
        const isEditing = addressId ? true : false;
        
        const url = isEditing 
            ? `/user/editAddress/${addressId}`
            : '/user/addAddress';
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (response.ok) {
            await Swal.fire({
                icon: 'success',
                title: 'Success',
                text: `Address ${isEditing ? 'updated' : 'added'} successfully!`,
                confirmButtonText: 'OK',
                confirmButtonColor: '#10B981'
            });
            
            // Close modal and refresh page to show new address
            toggleModal(false);
            location.reload();
        } else {
            throw new Error(data.message || 'Failed to save address');
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message || 'Something went wrong!',
            confirmButtonColor: '#EF4444'
        });
    }
  });

  // Function to handle address editing
  window.openEditModal = function(address) {
    document.getElementById('modalTitle').textContent = 'Edit Address';
    document.getElementById('addressId').value = address._id;
    document.getElementById('name').value = address.name;
    document.getElementById('addressLine1').value = address.addressLine1;
    document.getElementById('addressLine2').value = address.addressLine2 || '';
    document.getElementById('city').value = address.city;
    document.getElementById('state').value = address.state;
    document.getElementById('country').value = address.country;
    document.getElementById('pincode').value = address.pincode;
    document.getElementById('phoneNumber').value = address.phoneNumber;
    
    toggleModal(true);
  };

  // Function to handle address deletion
  window.deleteAddress = async function(addressId) {
    const result = await Swal.fire({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#EF4444',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Yes, delete it!'
    });

    if (result.isConfirmed) {
      try {
        const response = await fetch(`/user/deleteAddress/${addressId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok) {
          await Swal.fire({
            icon: 'success',
            title: 'Deleted!',
            text: 'Your address has been deleted.',
            confirmButtonColor: '#10B981'
          });
          location.reload();
        } else {
          throw new Error(data.message || 'Failed to delete address');
        }
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: error.message || 'Something went wrong!',
          confirmButtonColor: '#EF4444'
        });
      }
    }
  };
});
</script>