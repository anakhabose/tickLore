{{>header}}

<!-- Address Selection Section -->
<div class="container mx-auto p-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Left Column: Address Selection -->
        <div>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">Select Delivery Address</h2>
                <button onclick="openNewAddressForm()" 
                        class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg flex items-center">
                    <i class="fas fa-plus mr-2"></i>
                    Add New Address
                </button>
            </div>

            <!-- Address List -->
            <div class="space-y-4">
                {{#if addresses.length}}
                    {{#each addresses}}
                    <div class="border rounded-lg p-4 hover:border-yellow-500 transition-colors">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-3">
                                <input type="radio" 
                                       name="selectedAddress" 
                                       value="{{this._id}}" 
                                       class="mt-1 form-radio text-yellow-500" 
                                       onchange="handleAddressSelection('{{json this}}')" />
                                <div>
                                    <p class="font-semibold">{{this.name}}</p>
                                    <p>{{this.addressLine1}}</p>
                                    {{#if this.addressLine2}}
                                        <p>{{this.addressLine2}}</p>
                                    {{/if}}
                                    <p>{{this.city}}, {{this.state}}</p>
                                    <p>{{this.country}} - {{this.pincode}}</p>
                                    <p>Phone: {{this.phoneNumber}}</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editAddress('{{json this}}')" 
                                        class="text-blue-500 hover:text-blue-700">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteAddress('{{this._id}}')" 
                                        class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {{/each}}
                {{else}}
                    <div class="text-center py-8 bg-gray-50 rounded-lg">
                        <p class="text-gray-500">No addresses found. Please add a new address.</p>
                    </div>
                {{/if}}
            </div>
        </div>

        <!-- Right Column: Order Summary -->
        <div>
            <div class="bg-white shadow-lg rounded-lg p-6">
                <h2 class="text-lg font-semibold mb-4">Cart Total</h2>
                <div class="space-y-4">
                    <!-- Product List -->
                    <div class="space-y-4">
                        {{#each cartItems}}
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-3">
                                <img src="{{this.productId.images.[0]}}" alt="{{this.productId.productName}}" class="rounded-md w-12 h-12 object-cover" />
                                <span>{{this.productId.productName}} x {{this.quantity}}</span>
                            </div>
                            <div class="flex flex-col items-end">
                                {{#if this.hasOffer}}
                                    <span class="text-sm line-through text-gray-500">Rs.{{this.originalPrice}}</span>
                                    <span>Rs.{{this.salePrice}}</span>
                                {{else}}
                                    <span>Rs.{{this.originalPrice}}</span>
                                {{/if}}
                            </div>
                        </div>
                        {{/each}}
                    </div>

                    <!-- Summary Calculations -->
                    <div class="border-t pt-4">
                        <div class="flex justify-between border-b pb-4">
                            <span>Subtotal:</span>
                            <span>Rs. {{subtotal}}</span>
                        </div>
                        <div class="flex justify-between border-b pb-4">
                            <span>Shipping:</span>
                            <span>Rs. {{deliveryCharges}}</span>
                        </div>
                        <!-- Discount Row (initially hidden) -->
                        <div id="discountRow" class="flex justify-between border-b pb-4 hidden">
                            <span>Discount:</span>
                            <span id="discountAmount" class="text-green-600">-Rs. 0</span>
                        </div>
                        <div class="flex justify-between font-semibold pt-4">
                            <span>Total:</span>
                            <span id="finalTotal">Rs. {{totalAmount}}</span>
                        </div>
                    </div>

                    <!-- Coupon Section -->
                    <div class="mt-6">
                        <h3 class="font-semibold mb-2">Available Coupons</h3>
                        {{#if hasCoupons}}
                            {{#if hasOfferProducts}}
                                <div class="bg-gray-100 rounded-lg p-4 text-center text-gray-600">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    Coupons cannot be applied as some products already have offers
                                </div>
                            {{else}}
                                <div class="flex space-x-2">
                                    <select id="couponSelect" class="flex-1 border rounded-lg px-4 py-2">
                                        <option value="">Select a Coupon</option>
                                        {{#each availableCoupons}}
                                            <option value="{{this._id}}" 
                                                    data-discount="{{this.discount}}" 
                                                    data-min="{{this.minPurchaseAmount}}">
                                                {{this.couponCode}} - Save Rs.{{this.discount}} 
                                                (Min. Purchase: Rs.{{this.minPurchaseAmount}})
                                            </option>
                                        {{/each}}
                                    </select>
                                    <button type="button" 
                                            id="applyCouponBtn" 
                                            class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                                        Apply
                                    </button>
                                </div>
                            {{/if}}
                        {{else}}
                            <div class="bg-gray-100 rounded-lg p-4 text-center text-gray-600">
                                <i class="fas fa-ticket-alt mr-2"></i>
                                No coupons available for this purchase
                            </div>
                        {{/if}}
                    </div>

                    <!-- Payment Method Selection -->
                    <div class="mt-6 border-t pt-4">
                        <h3 class="font-semibold mb-4">Payment Method</h3>
                        {{#if isCodAvailable}}
                            <div class="space-y-3">
                                <label class="flex items-center space-x-3">
                                    <input type="radio" name="paymentMethod" value="cod" class="form-radio text-yellow-500">
                                    <span>Cash on Delivery</span>
                                </label>
                                <label class="flex items-center space-x-3">
                                    <input type="radio" name="paymentMethod" value="razorpay" class="form-radio text-yellow-500">
                                    <span>Razorpay</span>
                                </label>
                            </div>
                        {{else}}
                            <div class="mb-4">
                                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                                    <p class="font-bold">Note:</p>
                                    <p>Cash on Delivery is not available for orders above â‚¹1000. Please proceed with online payment.</p>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <label class="flex items-center space-x-3">
                                    <input type="radio" name="paymentMethod" value="razorpay" class="form-radio text-yellow-500" checked>
                                    <span>Razorpay</span>
                                </label>
                            </div>
                        {{/if}}
                    </div>

                    <!-- Place Order Button -->
                    <div class="mt-6">
                        <button type="button" 
                                onclick="submitOrder(event)"
                                class="w-full px-6 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-semibold">
                            Place Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Address Modal -->
<div id="addressModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h2 id="addressModalTitle" class="text-xl font-bold">Add New Address</h2>
            <button onclick="closeAddressModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="addressForm" class="space-y-4">
            <input type="hidden" id="addressId">
            <div>
                <label class="block text-sm font-medium text-gray-700">Full Name</label>
                <input type="text" id="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Address Line 1</label>
                <input type="text" id="addressLine1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Address Line 2 (Optional)</label>
                <input type="text" id="addressLine2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">City</label>
                    <input type="text" id="city" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">State</label>
                    <input type="text" id="state" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Country</label>
                    <input type="text" id="country" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Pincode</label>
                    <input type="text" id="pincode" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Phone Number</label>
                <input type="tel" id="phoneNumber" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <button type="submit" class="w-full bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-600">
                Save Address
            </button>
        </form>
    </div>
</div>

{{>userFooter}}

<script>
// Global variables
let selectedAddressData = null;
let originalTotal;
let currentDiscount = 0;
let currentCouponId = null;
let isCouponApplied = false;

// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize originalTotal
    const finalTotalElement = document.getElementById('finalTotal');
    if (finalTotalElement) {
        originalTotal = parseFloat(finalTotalElement.textContent.replace('Rs. ', ''));
    }

    // Add event listeners
    const couponButton = document.querySelector('#applyCouponBtn');
    if (couponButton) {
        couponButton.addEventListener('click', toggleCoupon);
    }

    const submitOrderBtn = document.querySelector('button[type="button"][class*="bg-yellow-500"]');
    if (submitOrderBtn) {
        submitOrderBtn.addEventListener('click', submitOrder);
    }

    // Initialize form validation
    const form = document.getElementById('billing-form');
    if (form) {
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            field.addEventListener('invalid', (e) => {
                e.preventDefault();
                Swal.fire({
                    title: 'Validation Error',
                    text: 'Please fill in all required fields.',
                    icon: 'warning',
                    confirmButtonText: 'OK'
                });
            });
        });
    }

    // Add modal event listeners
    const openModalBtn = document.querySelector('button[onclick="openAddressModal()"]');
    if (openModalBtn) {
        openModalBtn.removeAttribute('onclick');
        openModalBtn.addEventListener('click', openAddressModal);
    }

    const closeModalBtn = document.querySelector('button[onclick="closeAddressModal()"]');
    if (closeModalBtn) {
        closeModalBtn.removeAttribute('onclick');
        closeModalBtn.addEventListener('click', closeAddressModal);
    }
});

// Modal Functions
function openAddressModal() {
    const modal = document.getElementById('addressModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
    }
}

function closeAddressModal() {
    const modal = document.getElementById('addressModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.add('hidden');
    }
}

function selectAddress(address) {
    // Parse the address if it's a string
    const addressData = typeof address === 'string' ? JSON.parse(address) : address;
    
    const form = document.getElementById('billing-form');
    if (!form) {
        console.error('Billing form not found');
        return;
    }

    // Store the complete address object
    form.dataset.addressId = addressData._id;
    form.dataset.selectedAddress = JSON.stringify(addressData);
    
    // Fill form fields
    document.getElementById('companyName').value = addressData.name || '';
    document.getElementById('streetAddress').value = addressData.addressLine1 || '';
    document.getElementById('apartment').value = addressData.addressLine2 || '';
    document.getElementById('townCity').value = addressData.city || '';
    document.getElementById('state').value = addressData.state || '';
    document.getElementById('country').value = addressData.country || '';
    document.getElementById('pincode').value = addressData.pincode || '';
    document.getElementById('phone').value = addressData.phoneNumber || '';

    closeAddressModal();
    
    Swal.fire({
        icon: 'success',
        title: 'Address Selected',
        text: 'Delivery address has been selected successfully',
        timer: 1500,
        showConfirmButton: false
    });
}

function toggleCoupon() {
    if (!isCouponApplied) {
        applyCoupon();
    } else {
        removeCoupon();
    }
}

function applyCoupon() {
    const couponSelect = document.getElementById('couponSelect');
    if (!couponSelect) return;

    const selectedOption = couponSelect.options[couponSelect.selectedIndex];
    
    if (!selectedOption.value) {
        Swal.fire({
            icon: 'warning',
            title: 'No Coupon Selected',
            text: 'Please select a coupon to apply'
        });
        return;
    }

    const discountAmount = parseFloat(selectedOption.dataset.discount);
    const minimumPurchase = parseFloat(selectedOption.dataset.min);

    if (originalTotal < minimumPurchase) {
        Swal.fire({
            icon: 'error',
            title: 'Cannot Apply Coupon',
            text: `Minimum purchase amount of Rs.${minimumPurchase} required`,
        });
        return;
    }

    // Calculate final amount with discount
    const finalAmount = originalTotal - discountAmount;

    // Update UI
    const discountRow = document.getElementById('discountRow');
    const discountAmountElement = document.getElementById('discountAmount');
    const finalTotalElement = document.getElementById('finalTotal');
    const couponButton = document.querySelector('#applyCouponBtn');

    if (discountRow) discountRow.classList.remove('hidden');
    if (discountAmountElement) discountAmountElement.textContent = `-Rs.${discountAmount.toFixed(2)}`;
    if (finalTotalElement) finalTotalElement.textContent = `Rs.${finalAmount.toFixed(2)}`;
    if (couponButton) {
        couponButton.textContent = 'Remove';
        couponButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
        couponButton.classList.add('bg-red-500', 'hover:bg-red-600');
    }
    
    // Update global variables
    currentDiscount = discountAmount;
    currentCouponId = selectedOption.value;
    isCouponApplied = true;

    // Disable the coupon select while coupon is applied
    couponSelect.disabled = true;

    Swal.fire({
        icon: 'success',
        title: 'Coupon Applied!',
        text: `Discount of Rs.${discountAmount} has been applied to your order`,
    });
}

function removeCoupon() {
    const discountRow = document.getElementById('discountRow');
    const finalTotalElement = document.getElementById('finalTotal');
    const couponButton = document.querySelector('#applyCouponBtn');
    const couponSelect = document.getElementById('couponSelect');

    // Reset UI
    if (discountRow) discountRow.classList.add('hidden');
    if (finalTotalElement) finalTotalElement.textContent = `Rs.${originalTotal.toFixed(2)}`;
    if (couponButton) {
        couponButton.textContent = 'Apply';
        couponButton.classList.remove('bg-red-500', 'hover:bg-red-600');
        couponButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
    }

    // Reset coupon select
    if (couponSelect) {
        couponSelect.value = '';
        couponSelect.disabled = false;
    }

    // Reset variables
    currentDiscount = 0;
    currentCouponId = null;
    isCouponApplied = false;

    Swal.fire({
        icon: 'success',
        title: 'Coupon Removed',
        text: 'The coupon has been removed from your order',
    });
}

async function submitOrder(event) {
    event.preventDefault();
    
    // Check if an address is selected
    if (!selectedAddressData) {
        Swal.fire({
            icon: 'warning',
            title: 'Select Address',
            text: 'Please select a delivery address'
        });
        return;
    }

    // Get selected payment method
    const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
    if (!selectedPaymentMethod) {
        Swal.fire({
            icon: 'warning',
            title: 'Payment Method Required',
            text: 'Please select a payment method'
        });
        return;
    }

    const paymentMethod = selectedPaymentMethod.value;

    // Handle Razorpay payment
    if (paymentMethod === 'razorpay') {
        const paymentData = {
            address: selectedAddressData,
            couponId: currentCouponId,
            discountAmount: currentDiscount,
            finalAmount: originalTotal - currentDiscount
        };
        initiateRazorpayPayment(originalTotal, paymentData);
        return;
    }

    // Handle COD payment
    try {
        const orderData = {
            addressId: selectedAddressData._id,
            paymentMethod: paymentMethod,
            couponId: currentCouponId,
            discountAmount: currentDiscount,
            finalAmount: originalTotal - currentDiscount
        };

        const response = await fetch('/user/checkout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderData),
        });

        const result = await response.json();

        if (response.ok) {
            await Swal.fire({
                title: 'Order Placed!',
                text: 'Thank you for shopping with us.',
                icon: 'success',
                confirmButtonText: 'View Orders',
                allowOutsideClick: false,
                allowEscapeKey: false
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/user/orders';
                }
            });
        } else {
            throw new Error(result.message || 'Unable to process your order');
        }
    } catch (error) {
        console.error('Checkout error:', error);
        await Swal.fire({
            title: 'Error',
            text: error.message || 'Unable to process your order',
            icon: 'error',
            confirmButtonText: 'OK'
        });
    }
}

// Update the handleAddressSelection function
function handleAddressSelection(addressJson) {
    try {
        selectedAddressData = typeof addressJson === 'string' ? JSON.parse(addressJson) : addressJson;
        console.log('Selected address:', selectedAddressData);
    } catch (error) {
        console.error('Error parsing address:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Invalid address data'
        });
    }
}

// Razorpay Integration
function initiateRazorpayPayment(amount, paymentData) {
    const finalAmount = originalTotal - currentDiscount;
    
    fetch('/user/create-razorpay-order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            amount: originalTotal,
            discountedAmount: finalAmount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const options = {
                key: data.key,
                amount: data.order.amount,
                currency: "INR",
                name: "tickLore",
                description: "Order Payment",
                order_id: data.order.id,
                handler: function (response) {
                    verifyPayment(response, paymentData);
                },
                modal: {
                    ondismiss: async function() {
                        console.log('Payment modal dismissed. Creating pending order with data:', paymentData);
                        try {
                            // Ensure paymentData has all required fields
                            if (!paymentData || !paymentData.address) {
                                throw new Error('Invalid payment data');
                            }

                            const response = await fetch('/user/create-pending-order', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    address: paymentData.address,
                                    couponId: paymentData.couponId || null,
                                    discountAmount: paymentData.discountAmount || 0,
                                    finalAmount: paymentData.finalAmount || originalTotal
                                })
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.message || 'Failed to create order');
                            }

                            const result = await response.json();
                            
                            if (result.success) {
                                await Swal.fire({
                                    title: 'Payment Pending',
                                    text: 'Your order has been created. You can complete the payment from your orders page.',
                                    icon: 'info',
                                    confirmButtonText: 'Go to Orders'
                                });
                                window.location.href = '/user/orders';
                            } else {
                                throw new Error(result.message);
                            }
                        } catch (error) {
                            console.error('Error creating pending order:', error);
                            await Swal.fire({
                                title: 'Error',
                                text: error.message || 'Failed to create order. Please try again.',
                                icon: 'error'
                            });
                        }
                    }
                },
                prefill: {
                    name: document.getElementById('companyName').value,
                    email: document.getElementById('email').value,
                },
                theme: {
                    color: "#3399cc"
                }
            };
            const rzp = new Razorpay(options);
            rzp.open();
        } else {
            handlePaymentError(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        handlePaymentError("Network error occurred");
    });
}

function verifyPayment(response, paymentData) {
    if (!paymentData) {
        console.error('Payment data is missing');
        return;
    }

    const formData = {
        razorpay_payment_id: response.razorpay_payment_id,
        razorpay_order_id: response.razorpay_order_id,
        razorpay_signature: response.razorpay_signature,
        addressId: paymentData.address._id,
        address: paymentData.address,
        couponId: paymentData.couponId,
        discountAmount: paymentData.discountAmount,
        finalAmount: paymentData.finalAmount,
        paymentMethod: 'razorpay',
        paymentStatus: 'completed'
    };

    console.log('Verifying payment with data:', formData);

    // First verify the payment
    fetch('/user/verify-razorpay-payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            throw new Error(orderData.message || 'Failed to create order');
        }

        // Only show success message and redirect if both payment verification and order creation succeed
        return Swal.fire({
            icon: 'success',
            title: 'Order Placed Successfully!',
            text: 'Your payment was successful and order has been placed',
            allowOutsideClick: false,
            allowEscapeKey: false,
            allowEnterKey: false,
            showConfirmButton: true,
            confirmButtonText: 'View Orders'
        });
    })
    .then((result) => {
        if (result.isConfirmed) {
            window.location.href = '/user/orders';
        }
    })
    .catch(error => {
        console.error('Payment/Order creation error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message || 'Failed to process payment and create order',
            confirmButtonText: 'OK'
        }).then(() => {
            // Optionally redirect to cart or another appropriate page
            window.location.href = '/user/cart';
        });
    });
}

</script>